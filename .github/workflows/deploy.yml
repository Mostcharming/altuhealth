name: Deploy Application

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # --- Initial Setup ---
      - name: Checkout and pull latest code
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 300s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            BRANCH="${{ github.ref_name }}"

            echo "ðŸ“¦ Navigating to deployment directory..."
            cd "$DEPLOY_PATH"

            echo "ðŸŒ¿ Pull latest code from $BRANCH..."
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git reset --hard "origin/$BRANCH"

      # --- Backend ---
      - name: Build and deploy backend
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "ðŸ›  Installing backend dependencies..."
            cd "$DEPLOY_PATH/backend"
            npm ci --prefer-offline --no-audit --unsafe-perm
            echo "ðŸ”„ Running migrations..."
            npm run migrate || echo "âš ï¸ No migrations to run"

      # --- Frontend: Landing ---
      - name: Build frontend - landing
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "ðŸš€ Building landing..."
            cd "$DEPLOY_PATH/frontend/landing"
            rm -rf node_modules package-lock.json
            npm install --prefer-offline --no-audit --legacy-peer-deps --unsafe-perm
            npm run build

      # --- Frontend: Admin ---
      - name: Build frontend - admin
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "ðŸš€ Building admin..."
            cd "$DEPLOY_PATH/frontend/admin"
            rm -rf node_modules package-lock.json
            npm install --prefer-offline --no-audit --legacy-peer-deps --unsafe-perm
            npm run build

      # --- Frontend: Provider ---
      - name: Build frontend - provider
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "ðŸš€ Building provider..."
            cd "$DEPLOY_PATH/frontend/provider"
            rm -rf node_modules package-lock.json
            npm install --prefer-offline --no-audit --legacy-peer-deps --unsafe-perm
            npm run build

      # --- Frontend: Enrollee ---
      - name: Build frontend - enrollee
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "ðŸš€ Building enrollee..."
            cd "$DEPLOY_PATH/frontend/enrollee"
            rm -rf node_modules package-lock.json
            npm install --prefer-offline --no-audit --legacy-peer-deps --unsafe-perm
            npm run build

      # --- Frontend: Doctors ---
      - name: Build frontend - doctors
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "ðŸš€ Building doctors..."
            cd "$DEPLOY_PATH/frontend/doctors"
            rm -rf node_modules package-lock.json
            npm install --prefer-offline --no-audit --legacy-peer-deps --unsafe-perm
            npm run build

      # --- Frontend: Retail ---
      - name: Build frontend - retail
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 600s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "ðŸš€ Building retail..."
            cd "$DEPLOY_PATH/frontend/retail"
            rm -rf node_modules package-lock.json
            npm install --prefer-offline --no-audit --legacy-peer-deps --unsafe-perm
            npm run build

      # --- Final Deployment ---
      - name: Restart services with PM2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 300s
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            cd "$DEPLOY_PATH"
            echo "âš¡ Restarting services with PM2..."
            pm2 stop ecosystem.config.js 2>/dev/null || true
            pm2 delete ecosystem.config.js 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            pm2 status
