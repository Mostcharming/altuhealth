name: Deploy Application

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute full deployment
        uses: appleboy/ssh-action@master
        id: deploy
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 900s
          command_timeout: 900s
          script: |
            set -euo pipefail

            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            BRANCH="${{ github.ref_name }}"

            echo "ðŸ“¦ Navigating to deployment directory..."
            cd "$DEPLOY_PATH"

            echo "ðŸŒ¿ Pull latest code from $BRANCH..."
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git reset --hard "origin/$BRANCH"

            # --- Backend ---
            echo "ðŸ›  Installing backend dependencies..."
            cd backend
            npm ci --prefer-offline --no-audit --unsafe-perm
            echo "ðŸ”„ Running migrations..."
            npm run migrate || echo "âš ï¸ No migrations to run"
            cd ..

            # --- Frontend ---
            FRONTEND_APPS=("landing" "admin" "provider" "enrollee" "doctors" "retail")
            for app in "${FRONTEND_APPS[@]}"; do
              echo "ðŸš€ Building $app..."
              cd "frontend/$app"
              
              # Clean old node_modules and lock file
              rm -rf node_modules package-lock.json

              # Install dependencies and build
              npm ci --prefer-offline --no-audit --legacy-peer-deps --unsafe-perm
              npm run build
              cd ../../
            done

            # --- PM2 Management ---
            echo "âš¡ Restarting services with PM2..."
            pm2 stop ecosystem.config.js 2>/dev/null || true
            pm2 delete ecosystem.config.js 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            pm2 status
